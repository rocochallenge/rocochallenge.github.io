<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROCO Competition Leaderboard</title>

<style>
/* ----- Basic Reset ----- */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    transition: background 0.3s, color 0.3s;
}
.dark-mode {
    background: #1e1e1e;
    color: #ddd;
}

/* ----- Navbar ----- */
.navbar {
    background: #222;
    padding: 12px 20px;
    display: flex;
    gap: 20px;
}
.navbar a {
    color: white;
    text-decoration: none;
    font-size: 16px;
}
.navbar a:hover {
    text-decoration: underline;
}

/* ----- Container ----- */
.container {
    margin: 20px auto;
    width: 95%;
    max-width: 1500px;
}

/* ----- Top Tools (Search + Pagination + DarkMode Toggle + Export) ----- */
.tools {
    margin-bottom: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}
input[type="text"], select {
    padding: 6px;
    font-size: 14px;
}
button {
    padding: 6px 10px;
    cursor: pointer;
    border: 1px solid #888;
    background: #eee;
}
.dark-mode button {
    background: #444;
    color: #eee;
}

/* ----- Table ----- */
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}
.dark-mode table {
    background: #2a2a2a;
}
th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
    font-size: 14px;
}
.dark-mode th, .dark-mode td {
    border: 1px solid #444;
}
th {
    background: #eee;
}
.dark-mode th {
    background: #333;
}

/* Sort Button */
.sort-btn {
    background: #ddd;
    padding: 2px 5px;
    margin-left: 4px;
    font-size: 12px;
}
.dark-mode .sort-btn {
    background: #555;
}

/* ----- Team Expand Area ----- */
.details {
    display: none;
    background: #f9f9f9;
    padding: 10px;
    border-left: 5px solid #ccc;
    text-align: left;
}
.dark-mode .details {
    background: #333;
    border-left-color: #666;
}

/* ----- Medal Icons ----- */
.gold { color: #DAA520; font-weight: bold; }
.silver { color: #C0C0C0; font-weight: bold; }
.bronze { color: #CD7F32; font-weight: bold; }

/* ----- Page Navigation ----- */
.pagination {
    margin-top: 10px;
    display: flex;
    gap: 8px;
}
.pagination button {
    padding: 5px 8px;
}
</style>
</head>

<body>

<!-- Navbar -->
<div class="navbar">
    <a href="doc.html">Overview</a>
    <a href="index.html">Homepage</a>
</div>

<div class="container">

    <!-- Tools -->
    <div class="tools">
        <input type="text" id="search" placeholder="Search Team..." onkeyup="renderTable()">

        <label>Rows per page:</label>
        <select id="rowsPerPage" onchange="renderTable()">
            <option>5</option>
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
        </select>

        <button onclick="toggleDarkMode()">Dark / Light Mode</button>
        <button onclick="exportCSV()">Export CSV</button>

        <label>Secondary Sort:</label>
        <select id="secondarySort" onchange="renderTable()">
            <option value="None">None</option>
            <option value="S1">S1</option>
            <option value="S2">S2</option>
            <option value="S3">S3</option>
        </select>
    </div>

    <!-- Table -->
    <table>
        <thead>
        <tr>
            <th rowspan="2">Ranking</th>
            <th rowspan="2">Team Name</th>

            <th colspan="3">Task 1</th>
            <th colspan="3">Task 2</th>
            <th colspan="4">Task 3</th>

            <th rowspan="2">
                Final Score
                <button class="sort-btn" onclick="changeSort('FinalScore')">Sort</button>
            </th>
        </tr>
        <tr>
            <th>Correctly</th><th>Total</th>
            <th>S1 <button class="sort-btn" onclick="changeSort('S1')">Sort</button></th>

            <th>Successfully</th><th>Total</th>
            <th>S2 <button class="sort-btn" onclick="changeSort('S2')">Sort</button></th>

            <th>Removed</th><th>Recovery</th><th>Total</th>
            <th>S3 <button class="sort-btn" onclick="changeSort('S3')">Sort</button></th>
        </tr>
        </thead>

        <tbody id="tbody"></tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>

</div>

<script>
let data = [];
let currentSort = "FinalScore";
let sortDirection = -1; // descending default
let currentPage = 1;

/* Load JSON */
fetch("./docs/results.json")
    .then(r => r.json())
    .then(json => {
        data = json;
        renderTable();
    });

/* Change Primary Sort */
function changeSort(key) {
    if (currentSort === key) sortDirection *= -1;
    else {
        currentSort = key;
        sortDirection = -1;
    }
    renderTable();
}

/* Rendering Table */
function renderTable() {
    const searchText = document.getElementById("search").value.toLowerCase();
    const rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);
    const secondary = document.getElementById("secondarySort").value;

    // Filter by search
    let filtered = data.filter(x =>
        x.Team.toLowerCase().includes(searchText)
    );

    // Sort primary
    filtered.sort((a, b) => sortDirection * (a[currentSort] - b[currentSort]));

    // Secondary sort (if same)
    if (secondary !== "None") {
        filtered.sort((a, b) => {
            if (a[currentSort] === b[currentSort])
                return b[secondary] - a[secondary];
            return sortDirection * (a[currentSort] - b[currentSort]);
        });
    }

    // Pagination
    const totalPages = Math.ceil(filtered.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages);
    const start = (currentPage - 1) * rowsPerPage;
    const pageData = filtered.slice(start, start + rowsPerPage);

    // Render rows
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    pageData.forEach((t, i) => {
        const globalRank = filtered.indexOf(t) + 1;

        // Medal
        let rankDisplay = globalRank;
        if (globalRank === 1) rankDisplay = `<span class="gold">ðŸ¥‡ 1</span>`;
        else if (globalRank === 2) rankDisplay = `<span class="silver">ðŸ¥ˆ 2</span>`;
        else if (globalRank === 3) rankDisplay = `<span class="bronze">ðŸ¥‰ 3</span>`;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${rankDisplay}</td>
            <td onclick="toggleDetails(this)">${t.Team}</td>

            <td>${t.T1_Correctly}</td>
            <td>${t.T1_Total}</td>
            <td>${t.S1}</td>

            <td>${t.T2_Success}</td>
            <td>${t.T2_Total}</td>
            <td>${t.S2}</td>

            <td>${t.T3_Removed}</td>
            <td>${t.T3_Recovery}</td>
            <td>${t.T3_Total}</td>
            <td>${t.S3}</td>

            <td>${t.FinalScore}</td>
        `;
        tbody.appendChild(row);

        // Details row
        const detail = document.createElement("tr");
        detail.classList.add("details");
        detail.innerHTML = `
            <td colspan="13">
                <strong>Team Info:</strong><br>
                Robot: ${t.Robot}<br>
                Algorithm: ${t.Algorithm}<br>
                Institution: ${t.Institution}<br>
            </td>
        `;
        tbody.appendChild(detail);
    });

    renderPagination(totalPages);
}

/* Expand team details */
function toggleDetails(td) {
    const nextRow = td.parentElement.nextElementSibling;
    nextRow.style.display = nextRow.style.display === "table-row" ? "none" : "table-row";
}

/* Pagination */
function renderPagination(total) {
    const div = document.getElementById("pagination");
    div.innerHTML = "";

    for (let i = 1; i <= total; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        if (i === currentPage) btn.style.fontWeight = "bold";
        btn.onclick = () => {
            currentPage = i;
            renderTable();
        };
        div.appendChild(btn);
    }
}

/* Dark Mode */
function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
}

/* Export CSV */
function exportCSV() {
    let csv = "Team,FinalScore,S1,S2,S3\n";
    data.forEach(t => {
        csv += `${t.Team},${t.FinalScore},${t.S1},${t.S2},${t.S3}\n`;
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "leaderboard.csv";
    a.click();
}
</script>

</body>
</html>
